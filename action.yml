name: 'Deploy to Posit Connect'
description: 'Deploy content to Posit Connect using with-connect'
inputs:
  connect-license:
    description: 'Posit Connect license key'
    required: true
  connect-version:
    description: 'Posit Connect version to use'
    required: false
    default: '2025.09.0'
  config-file:
    description: 'Path to optional rstudio-connect.gcfg configuration file'
    required: false
  command:
    description: 'Command to run against Connect'
    required: true
  env:
    description: 'Environment variables to pass to command (YAML object)'
    required: false

runs:
  using: composite
  steps:
    - name: Set up uv
      uses: astral-sh/setup-uv@v7
      with:
        activate-environment: true
        working-directory: ${{ github.action_path }}

    - name: Install with-connect
      shell: bash
      run: uv pip install ${{ github.action_path }}

    - name: Create license file
      shell: bash
      run: echo "${{ inputs.connect-license }}" > rstudio-connect.lic

    - name: Deploy to Connect
      shell: bash
      run: |
        ARGS="--version ${{ inputs.connect-version }}"
        if [ -n "${{ inputs.config-file }}" ]; then
          ARGS="$ARGS --config ${{ inputs.config-file }}"
        fi
        if [ -n "${{ inputs.env }}" ]; then
          for key in $(echo '${{ inputs.env }}' | jq -r 'keys[]'); do
            value=$(echo '${{ inputs.env }}' | jq -r --arg k "$key" '.[$k]')
            ARGS="$ARGS -e ${key}=${value}"
          done
        fi
        with-connect $ARGS -- ${{ inputs.command }}
